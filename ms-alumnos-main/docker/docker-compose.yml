version: "3.9"

services:
  alumnos-service:
    image: gestion-alumnos:v1.0.0

    deploy:
      replicas: 3
      labels:
        - "traefik.enable=true"
        - "traefik.scope=swarm"
        - "traefik.http.routers.alumnos-service.rule=Host(`alumnos.universidad.localhost`)"
        - "traefik.http.routers.alumnos-service.entrypoints=web"
        - "traefik.http.routers.alumnos-service.middlewares=alumnos-service-cb,alumnos-service-retry"
        - "traefik.http.services.alumnos-service.loadbalancer.server.port=5000"
        - "traefik.docker.network=mired"

        # Patron Circuit Breaker y Retries
        - "traefik.http.middlewares.alumnos-service-cb.circuitbreaker.expression=LatencyAtQuantileMS(50.0) > 100 || ResponseCodeRatio(500, 600, 0, 600) > 0.25 || NetworkErrorRatio() > 0.5"
        - "traefik.http.middlewares.alumnos-service-retry.retry.attempts=3"
        - "traefik.http.middlewares.alumnos-service-retry.retry.initialinterval=1s"

    environment:
      FLASK_CONTEXT: production
      SQLALCHEMY_DATABASE_URI: postgresql+psycopg2://postgres:nico@host.docker.internal:5432/test_sysacad
      HOST_DB: host.docker.internal
      USER_DB: postgres
      PASSWORD_DB: nico
      NAME_DB: test_sysacad
      REDIS_HOST: host.docker.internal
      REDIS_PORT: "6379"
      REDIS_PASSWORD: ""

    networks:
      mired:
        aliases:
          - alumnos.universidad.localhost

networks:
  mired:
    external: true
